name: Deploy to FTP

on:
  push:
    branches: [main]

jobs:
  ftp-deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 15

    strategy:
      max-parallel: 1
      matrix:
        target:
          - { name: "en", dir: "/public_html/en/wp-content/themes/twentytwentyfive/" }

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      # MoÅ¼esz ten krok pÃ³Åºniej wyciÄ…Ä‡, jest tylko diagnostyczny
      - name: Connectivity checks
        shell: bash
        env:
          FTP_HOST: ${{ secrets.FTP_HOST }}
        run: |
          set -e
          echo "DNS ->"
          nslookup "$FTP_HOST" || true

          echo
          echo "TCP:21 ->"
          (timeout 5 bash -lc "cat < /dev/null > /dev/tcp/$FTP_HOST/21" && echo "ok") || echo "fail"

      - name: Upload to ${{ matrix.target.name }} (${{ matrix.target.dir }})
        uses: SamKirkland/FTP-Deploy-Action@v4.3.6
        with:
          server:   ${{ secrets.FTP_HOST }}
          username: ${{ secrets.FTP_USERNAME }}
          password: ${{ secrets.FTP_PASSWORD }}

          # ðŸ‘‡ TEST: zwykÅ‚y FTP, bez TLS
          protocol: ftp
          port: 21

          server-dir: ${{ matrix.target.dir }}
          # jeÅ›li motyw jest w podkatalogu, np. "theme-en", zmieÅ„ na ./theme-en/
          local-dir: ./ 

          state-name: .ftp-deploy-sync-state-${{ matrix.target.name }}.json

          log-level: verbose
          timeout: 120000

          exclude: |
            **/.git*
            **/.git*/**
            **/.github*
            **/.github*/**
            **/node_modules/**
            **/*.md
            **/README*
            **/tests/**
            **/.ftp-deploy-sync-state*.json
